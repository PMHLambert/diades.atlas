---
title: "Translation"
author: "Colin Fay"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(eval = FALSE)
```

Si c'est n√©cessaire, se connecter √† la base de donn√©es en suivant les instructions du Readme.Rmd

```{r}
# Chargement des packages
pkgload::load_all(attach_testthat = FALSE)
library(dplyr)
library(here)

# Connexion √† la base si n√©cessaire
session <- new.env()
connect(session)
```

## Comment est organis√©e la traduction

__Note importante__ : Pensez √† √™tre bien vigilant sur l'harmonisation des code-langues. 
En d'autres termes, si l'on ajoute une langue avec le code `es`, ce code doit √™tre strictement respect√© partout, sinon la traduction ne pourra pas √™tre effectu√©e correctement dans l'application. 

### Pour le front-end 

Pour l'interface utilisateur, l'application combine les fichiers csv contenus dans le
dossier `inst/` et des tables contenues dans la base de donn√©es PostGres. 
 
Tous ces fichiers/tables contiennent au moins 5 colonnes: 

+ `entry` : la cl√© d'entr√©e dans le front (pour i18n)
+ `en` : la traduction en anglais
+ `fr` : la traduction en fran√ßais
+ `es` : la traduction en espagnol
+ `pt` : la traduction en portugais

#### Lus dans la base de donn√©es directement

Si la requ√™te SQL pour r√©cup√©rer les tables suivantes doit changer, alors ces fonctions sont √† mettre √† jour dans `R/utils_helpers.R`. 
Sinon, il n'y a rien √† faire c√¥t√© R lors d'ajout de traductions dans la base.

+ `abundance_level`

```{r}
translation_abundance_level(session)
```

=> Cette fonction est √† mettre √† jour dans `R/utils_helpers.R`

+ `species` : contient les traductions pour les √©l√©ments de niveau d'abondance. 

```{r}
translation_species(session)
```

=> Cette fonction est √† mettre √† jour dans `R/utils_helpers.R`

+ `v_ecosystemic_services`

```{r}
translation_v_ecosystemic_services(session)
```

=> Cette fonction est √† mettre √† jour dans `R/utils_helpers.R`


#### Fichiers √† compl√©ter √† la main 

+ `inst/translation_help.csv` : contient la traduction pour les bulles d'aide. Les bulles d'aide sont les bulles qui s'affichent lors du passage de la souris sur un √©l√©ment `(?)`.
  + Lire le csv avec un s√©parateur virgule `,` et avec l'option "Formater les champs entre guillemets comme texte"
  + Le texte dans les cases de langues peut s'√©cire avec une syntaxe markdown pour mettre en forme le texte
  + Enregistrer le csv avec un s√©parateur virgule `,`

+ `inst/translation_iucn.csv` : contient les traductions des status IUCN. 
  + Lire le csv avec un s√©parateur virgule `,` et avec l'option "Formater les champs entre guillemets comme texte"
  + Enregistrer le csv avec un s√©parateur virgule `,`
  
+ `inst/translation.csv` : contient tous les autres √©l√©ments traduisibles de l'interface utilisateur.
  + Lire le csv avec un s√©parateur virgule `,` et avec l'option "Formater les champs entre guillemets comme texte"
  + Enregistrer le csv avec un s√©parateur virgule `,`

Ces fichiers partagent la m√™me structure. Ces derniers doivent poss√©der a minima: 

+ Une premi√®re colonne nomm√©e 'entry'
+ Une seconde colonne nomm√©e 'en'
+ Une troisis√®me colonne nomm√©e 'fr'
+ Une quatri√®me colonne nomm√©e 'es'
+ Une cinqui√®me colonne nomm√©e 'pt'
+ PAS DE COLONNES VIDES SUR LA DROITE, pensez √† l'anti-s√©lectionner au besoin.

NB: Dans le cas de `inst/translation.csv`, la premi√®re colonne est 'DESCRIPTION'.
Elle comporte une description plus d√©taill√©e de la ligne en question.

Vous pouvez v√©rifier l'int√©grit√© du csv √† l'aide de la fonction `check_translation_csv()`:

```{r}
translation_help <- check_translation_csv(here::here("inst/translation_help.csv"))
head(translation_help)
```

```{r}
translation_iucn <- check_translation_csv(here::here("inst/translation_iucn.csv"))
head(translation_iucn)
```

```{r}
translation <- check_translation_csv(here::here("inst/translation.csv"))
head(translation)
```

## Ajouter une nouvelle langue 

Ajouter une nouvelle langue doit se faire aux emplacements suivants:

### Fichiers √† modifier

Dans les fichiers manuellement mis √† jour:

+ `translation_help.csv`

+ `translation_iucn.csv`

+ `translation.csv`

Ajouter une nouvelle colonne √† droite dont le titre correspond √† l'abbr√©viation de la
nouvelle langue par exemple `es` pour l'espagnol et compl√©ter chaque entr√©e
avec la traduction.

### Fonctions bdd

Ces fonctions sont dans `R/utils_helpers.R`

Les fonctions qui utilisent la traduction dans la bdd sont les suivantes : 

+ `translation_abundance_level()` : il faudra ajouter une partie au SQL type `diadesatlas.translate(abundance_level_interpretation_short, 'es') AS es`

+ `translation_species()` : il faudra ajouter une partie au SQL type `diadesatlas.translate(english_name, 'es') AS es`

+ `translation_v_ecosystemic_services()` pour chaque sous requ√™te SQL, il faudra ajouter une partie au SQL type `diadesatlas.translate(subcategory_name, 'es') as es` 

### C√¥t√© code de l'application

- Si disponible, ajouter le langage dans `get_dt_lg()` , √† v√©rifier sur https://cdn.datatables.net/plug-ins/1.10.11/i18n/

- Dans `R/app_ui.R`, ajouter une entr√©e pour le s√©lecteur de langue. Si votre entr√©e de langue est `es`, ajouter `<option value="en">\U0001f1ea\U0001f1f8 Espanol</option>`. Le code unicode s'obtient en utilisant l'√©moji et `stringi::stri_escape_unicode("üá™üá∏")`.

## Notes pour les d√©velopeurs 

### Comment cr√©er un nouvel √©l√©ment "traductible" dans l'UI

+ La traduction est assur√©e par le module JS `i18n` et la fonction `with_i18()` dans l'app

```{r}
with_i18(
  "Text de base",
  "text_de_base"
)
```

Va cr√©er `<span data-i18n="text_de_base">Text de base</span>`. 

+ L'√©l√©ment `Text de base` est affich√© si `i18n` plante
+ L'√©l√©ment `data-i18n="text_de_base"` correspond √† la cl√© d'entr√©e dans le data.frame de traduction, i.e. la valeur dans la colonne entry. 

Sch√©matiquement, lorsque le JavaScript va traduire la page, il va aller chercher pour chaque tag l'entr√©e `data-i18n`, en tirer la valeur, et aller chercher la traduction correspondante. 

Par exemple, si nous traduisons en "fr", la localisation fait (en JavaScript) l'action suivante 

```{r eval = FALSE}
df_traduction %>%
  filter(entry == "text_de_base") %>%
  pull(fr)
```

### Comment cr√©er un nouvel √©l√©ment "traductible" dans le server

#### Soit la traduction existe dans la base de donn√©es

Si vous √™tes dans une chaine d'op√©rations qui s'effectue dans la base de donn√©es (avant un `collect()`), vous pouvez utiliser la fonction `diadesatlas.translate()` qui est incluse dans la base. C'est bien une fonction SQL incluse dans la base PostGIS et non pas une fonction R.  
Dans R, cela se traduit par un `mutate()` de la colonne √† traduire comme ceci:

```{r, eval=FALSE}
# lg <- 'fr'
db %>%
  mutate(basin_name = diadesatlas.translate(basin_name, !!lg)) %>% 
  collect()
```

#### Soit la traduction n'est pas dans la base

La traduction doit donc exister dans le csv de traduction.  
Dans ce cas, nous utilisons la fonction R de notre package  `get_translation_entry()`
```{r}
get_translation_entry(entry = 'hsi_ggplot', lg = 'fr')
```

+ L'√©l√©ment `entry = 'hsi_ggplot'` correspond √† la cl√© d'entr√©e dans le data.frame de traduction, i.e. la valeur dans la colonne entry. 
