---
title: "be-page4-future"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{be-page4-future}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE # Set to TRUE when data OK for test, but not on GitHub
)
# To compile manually : See README
```

```{r setup}
library(diades.atlas)
library(dplyr)
library(leaflet)
library(ggplot2)
```

### Connect to database

Do not forget to set environment variables in .Renviron
```{r}
# Connect to database
conn_eurodiad <- connect()

# Listtables
# sort(DBI::dbListTables(conn_eurodiad))
# DBI::dbListObjects(conn_eurodiad)
```

## Prepare Data

Queries from preparation_atlas_simulation.R

```{r}
data_simulation <- get_data_simulation(conn_eurodiad)
data_catchment <- data_simulation[["data_catchment"]]
data_catchment
data_simulation[["outlet_distance"]]
hydiad_parameter <- data_simulation[["hydiad_parameter"]]
hydiad_parameter
data_hsi_nmax <- data_simulation[["data_hsi_nmax"]]
data_hsi_nmax
data_simulation[["reference_results"]]
data_simulation[["data_ni0"]]
```

## Prepare data frame of simulation

- Use anthropogenic mortality from slider on the Shiny interface

```{r}
session <- shiny::MockShinySession$new()
input <- list()
datasets <- generate_datasets(con = conn_eurodiad)
lang <- "fr"

# Generate all inputs as in the Shiny application
countries <- c("all", datasets[["countries_mortalities_list"]])

mortalities <- data.frame(
 X1 = datasets[["countries_mortalities_list"]],
 X2 = 0.1,
 X3 = 0.1
) %>% setNames(
  c(
    "Country",
    get_translation_entry(entry = 'yearsimubegin', lg = 'fr'),
    get_translation_entry(entry = 'yearsimuend', lg = 'fr')
  )
)


# # build from sliders in interface 
# expand grid
anthropogenic_mortality <- full_join(data_hsi_nmax %>% 
            distinct(year) %>% 
            mutate(by = 1),
          data_hsi_nmax %>% 
            distinct(country) %>% 
            mutate(by = 1), by = "by") %>% 
    mutate(h2 = 0) %>% 
  mutate(
    h1 = case_when(
      between(year, 2001, 2050) & country == 'France' ~ -log(.5),
      between(year, 2051, 2100) & country == 'France' ~ -log(.75),
      TRUE ~ 0
    ))

```



### Stop connection

```{r}
DBI::dbDisconnect(conn_eurodiad)
```
